var hzAdDebug=!1,hzVersion="4.16",keywords,adCont,urlPrefix=!hzAdDebug&&"https:"==location.protocol?"https://ssl14.ovh.net/~hoverzoo":"http://hoverzoom.net";
function addAffiliateLinks(){try{if("www.youtube.com"==location.host){for(var a=null,k=null,b=document.querySelectorAll("#watch-description-extra-info .metadata-info-title"),e=0;e<b.length;e++)0==b[e].textContent.indexOf("Buy")&&(a=b[e].textContent.match(/Buy "(.*)" on/))&&(a=a[1]),-1<b[e].textContent.indexOf("Artist")&&(k=b[e].nextSibling.nextSibling.textContent);if(null===a||null===k)return;var d=k+" "+a,l=document.querySelectorAll('.metadata-info a[href*="itunes"], .metadata-info a[href*="googlemusic"]');
if(0==l.length)return;var l=l[0],g=document.createElement("a");g.target="_blank";g.className="nowrap";g.textContent="Amazon";g.title='Buy "'+a+'" on Amazon by courtesy of Hover Zoom';g.href="http://www.amazon.com/gp/search?ie=UTF8&camp=1789&creative=9325&index=music&keywords="+encodeURIComponent(d)+"&linkCode=ur2&tag=hzyt-20";l.parentElement.appendChild(g)}var h=Math.random();if("www.facebook.com"==location.host&&(0.7>h||hzAdDebug))if(adCont=document.getElementById("pagelet_ego_pane_w")){d=0.4>Math.random()?
"_default":getKeywords();hzAdDebug&&console.log(d);var c=localStorage["hzLinkCache "+d];c&&(c=JSON.parse(c)).expiration>Date.now()?createAffiliatelinks(c):(localStorage.removeItem("hzLinkCache "+d),searchItems(d,function(a){a=JSON.parse(a);keywordsLinks={links:[]};for(var b=0,e=a.links.length;b<e;b++){var c=a.links[b];(c.keywords==d||!c.keywords&&"_default"==d)&&keywordsLinks.links.push(c)}keywordsLinks.expiration=Date.now()+864E5;localStorage["hzLinkCache "+d]=JSON.stringify(keywordsLinks);createAffiliatelinks(keywordsLinks)}))}}catch(f){if(hzAdDebug)throw f;
}}
function sanitizeString(a){a=a.toLowerCase();a=a.replace(/^\s+(.*)\s+$/,"\u0001");a=a.replace(/[\u00e0\u00e1\u00e2\u00e3\u00e4\u00e5]/g,"a");a=a.replace(/\u00e6/g,"ae");a=a.replace(/\u00e7/g,"c");a=a.replace(/[\u00e8\u00e9\u00ea\u00eb]/g,"e");a=a.replace(/[\u00ec\u00ed\u00ee\u00ef]/g,"i");a=a.replace(/\u00f1/g,"n");a=a.replace(/[\u00f2\u00f3\u00f4\u00f5\u00f6]/g,"o");a=a.replace(/\u0153/g,"oe");a=a.replace(/[\u00f9\u00fa\u00fb\u00fc]/g,"u");a=a.replace(/[\u00fd\u00ff]/g,"y");return a=a.replace(/[^a-z1-9 ]/g,"")}
function getKeywords(){var a;a=document.querySelectorAll('a[data-hovercard*="hovercard/page"], #pagelet_ego_pane_w .actorName a');return 0<a.length?(keywords=a[Math.floor(Math.random()*a.length)].textContent,(a=sanitizeString(keywords))||"_default"):"_default"}
function searchItems(a,k){var b=urlPrefix+"/api/amazon/getlinks/amazonlinks.php?ct=fb1&cv="+hzVersion+"&kw="+encodeURIComponent(a);hzAdDebug&&(b+="&geo=us");chrome.extension.sendRequest({action:"ajaxGet",url:b},function(a){try{a&&(a=a.substr(a.indexOf("{")),hzAdDebug&&console.log(a),k(a))}catch(b){if(hzAdDebug)throw b;}})}
function createAffiliatelinks(a){try{for(var k=0,b=a.links[Math.floor(Math.random()*a.links.length)];!b.end&&5>k++;)b=a.links[Math.floor(Math.random()*a.links.length)];var e=b.title||keywords||"",d=b.text+"<br>",l=b.list_price||b.best_price,g=b.img_url,h=adCont.querySelector("[data-ad]");if(d&&b.url){for(;null!=h&&-1==h.className.indexOf("ego_unit_container");)h=h.parentElement;if(null!=h){g||(g=chrome.extension.getURL("images/fb-amazon.png"));l&&(d+="<br><b>"+l+"</b>");var c='<div class="uiSelector inlineBlock emu_x emuEventfad_hide  fbEmuLink uiSelectorRight"><div class="wrap"><a id="hzCloseAd" style="visibility: hidden" href="http://hoverzoom.net/aboutads/" target="_blank" title="About this ad"><img src="'+
chrome.extension.getURL("images/fb-close.png")+'"></a></div></div>',c=c+('<div class="title" style="color: #3B5998; font-weight: bold; margin-bottom: 4px"><a class="forceLTR" href="'+b.url+'" target="_blank">'+e+"</a></div>"),c=c+('<div class="clearfix image_body_block"><a class="emuEvent1 _24x image fbEmuImage _8o _8s lfloat" href="'+b.url+'" target="_blank">'),c=c+('<img src="'+g+'" style="max-width: 100px; max-height: 72px"></a><div>'),c=c+('<div class="_8m"><div class="body"><a class="forceLTR emuEvent1" style="color: #333; text-decoration: none;" href="'+
b.url+'" target="_blank">'+d+"</a></div></div>"),c=c+"</div>";window.removeEventListener("DOMNodeInserted",windowOnDOMNodeInserted);var f=document.createElement("div");f.id="hoverZoomAd";f.className="ego_unit";f.dataset.keywords=e.replace(/['"]/g," ");f.innerHTML=c;h.insertBefore(f,h.children[Math.floor(Math.random()*h.childElementCount)]);window.addEventListener("DOMNodeInserted",windowOnDOMNodeInserted);var m=document.getElementById("hzCloseAd");f.addEventListener("mouseover",function(){m.style.visibility=
"visible"});f.addEventListener("mouseout",function(){m.style.visibility="hidden"});chrome.extension.sendRequest({action:"trackEvent",event:{category:"Ads",action:"FacebookAdDisplayed",label:f.dataset.keywords}});f.addEventListener("click",function(){chrome.extension.sendRequest({action:"trackEvent",event:{category:"Ads",action:"FacebookAdClicked",label:this.dataset.keywords}})})}}}catch(n){if(hzAdDebug)throw n;}}
function windowOnDOMNodeInserted(a){a.target&&("ego_column"==a.target.className&&a.target.parentElement&&"pagelet_ego_pane_w"==a.target.parentElement.id&&!document.getElementById("hoverZoomAd"))&&addAffiliateLinks();a.target&&("egoRefreshAds"==a.target.id&&!document.getElementById("hoverZoomAd"))&&addAffiliateLinks()}chrome.extension.sendRequest({action:"getOptions"},function(a){2>a.enableAds&&(addAffiliateLinks(),"www.facebook.com"==location.host&&window.addEventListener("DOMNodeInserted",windowOnDOMNodeInserted))});
