<html>
<head><title>Google Translate for Google+</title>
  <link rel='stylesheet' type='text/css' href='options.css'>
  <link rel='stylesheet' type='text/css' href='options_css_compiled.css'>
  <script type='text/javascript'>
  // This should be the same as whats in our BUILD file, but the following have
  // been removed, bacause we don't have a product logo for this locale, and
  // that is the primary use of verifying on this list
  // Removed: bs, zh, pt
  var SUPPORTED_LOCALES = [
    'af', 'ar', 'az', 'be', 'bg', 'bn', 'ca', 'cs', 'cy', 'da', 'de', 'el',
    'en', 'en-GB', 'es', 'et', 'eu', 'fa', 'fi', 'fil', 'fr', 'ga', 'gl', 'gu',
    'hi', 'hr', 'ht', 'hu', 'hy', 'id', 'is', 'it', 'iw', 'ja', 'ka', 'kn', 'ko',
    'lt', 'lv', 'mk', 'ms', 'mt', 'nl', 'no', 'pl', 'pt-BR', 'pt-PT', 'ro',
    'ru', 'sk', 'sl', 'sq', 'sr', 'sv', 'sw', 'ta', 'te', 'th', 'tl', 'tr', 'uk',
    'ur', 'vi', 'yi', 'zh-CN', 'zh-TW'
  ];

  // Saves options to localStorage.
  function save_options(opt_autoSaved) {
    var select = document.querySelector('#gt-lang');
    var lang = select.children[select.selectedIndex].value;
    localStorage['gt-lang'] = lang;

    var autoAdd = document.querySelector('#autoAdd');
    localStorage['gt-autoAdd'] = autoAdd.checked;

    var color = document.querySelector('#color');
    localStorage['gt-color'] = color.value;

    // Update status to let user know options were saved.
    var status = document.querySelector('#status');
    status.style.visibility = 'visible';
    if (opt_autoSaved) {
      status.innerHTML = chrome.i18n.getMessage('autosaved');
    } else {
      status.innerHTML = chrome.i18n.getMessage('options_saved');
    }
    setTimeout(function() {
      status.style.visibility = 'hidden';
    }, 750);
  }

  function selectOption(select, value) {
    for (var i = 0; i < select.children.length; i++) {
      var child = select.children[i];
      if (child.value == value) {
        child.selected = 'true';
        break;
      }
    }
  }

  // Restores select box state to saved value from localStorage.
  function restore_options() {
    var lang = localStorage['gt-lang'];
    if (!lang) lang = normalizeLangcode(window.navigator.language);
    var select = document.querySelector('#gt-lang');
    selectOption(select, lang);

    var autoAdd = document.querySelector('#autoAdd');
    autoAdd.checked = (localStorage['gt-autoAdd'] != 'false');

    if (localStorage['gt-color']) {
      var color = document.querySelector('#color');
      color.value = localStorage['gt-color'];
      updateExample(true);
    }
  }

  function changeLang() {
    save_options(true);
  }

  function changeAuto() {
    save_options(true);
  }

  function prependZeroIfNecessary(hex) {
    return hex.length == 1 ? '0' + hex : hex;
  }

  function styleColorStringToHex(rgbString) {
    var trimmed = rgbString.substr(4, rgbString.length-5);
    var rgb = trimmed.split(', ');
    return rgbToHex(rgb[0], rgb[1], rgb[2]);
  }

  function rgbToHex(r, g, b) {
    r = Number(r);
    g = Number(g);
    b = Number(b);
    var hexR = prependZeroIfNecessary(r.toString(16));
    var hexG = prependZeroIfNecessary(g.toString(16));
    var hexB = prependZeroIfNecessary(b.toString(16));
    return '#' + hexR + hexG + hexB;
  };

  function updateExample(opt_dontsave) {
    document.querySelector('#example').style['background-color'] =
        document.querySelector('#color').value;
    if (!opt_dontsave) {
      save_options(true);
    }
  }

  function supportedLanguage(code) {
    return SUPPORTED_LOCALES.indexOf(code) != -1;
  }

  function normalizeLangcode(code) {
    if (code.toLowerCase() == 'zh-tw') return 'zh-TW';
    if (code.toLowerCase() == 'zh-cn') return 'zh-CN';
    if (code.toLowerCase() == 'pt-pt') return 'pt-PT';
    if (code.toLowerCase() == 'pt-br') return 'pt-BR';
    if (code.length >= 2 && supportedLanguage(code)) return code.substr(0,2);
    else return 'en';
  }

  // TODO(jestelle): the page loads without localizations at first and has them
  // quickly replaced... it'd be nice if at initial render time everything was
  // there
  function setupLocalization() {
    document.title = chrome.i18n.getMessage('extension_name');

    var imgUrl = 'http://www.gstatic.com/translate/intl/' +
                 normalizeLangcode(window.navigator.language) +
                 '/logo2.png';
    var googleTranslate = chrome.i18n.getMessage('google_translate');

    document.querySelector('#logo').innerHTML =
        chrome.i18n.getMessage('gt_img_for_gplus',
            '<img src="' + imgUrl + '" title="' + googleTranslate +
            '" alt="' + googleTranslate + '"><br>');

    document.querySelector('#language').textContent =
        chrome.i18n.getMessage('language');

    loadSupportedLanguages();

    document.querySelector('#languageDesc').textContent =
        chrome.i18n.getMessage('language_desc');

    document.querySelector('#autoAddLabel').textContent =
        chrome.i18n.getMessage('always_add');

    document.querySelector('#autoAddDesc').textContent =
        chrome.i18n.getMessage('always_add_desc');

    document.querySelector('#background').textContent =
        chrome.i18n.getMessage('background');

    document.querySelector('#example').textContent =
        chrome.i18n.getMessage('example');
  }

  function loadSupportedLanguages() {
    var displayLang = normalizeLangcode(window.navigator.language);

    var s = document.createElement('script');
    s.src = 'http://translate.google.com/translate_a/l?client=es' +
            '&cb=supportedLanguagesCallback&hl=' + displayLang;
    document.querySelector('head').appendChild(s);
  }

  function supportedLanguagesCallback(langs) {
    var selector = document.querySelector('#gt-lang');

    if ('tl' in langs) {
      selector.innerHTML = '';

      for (var langCode in langs['tl']) {
        var newOption = document.createElement('option');
        newOption.value = langCode;
        newOption.textContent = langs['tl'][langCode];
        selector.appendChild(newOption);
      }

      var lang = localStorage['gt-lang'];
      if (!lang) lang = normalizeLangcode(window.navigator.language);
      selectOption(selector, lang);
    }
  }

  function init() {
    setupLocalization();

    restore_options();

    var colorSelector = document.querySelector('#colorselector');
    colorSelector.addEventListener('click', function (e) {
      if (e.target && e.target.style['background-color']) {
        document.querySelector('#color').value =
            styleColorStringToHex(e.target.style['background-color']);
        updateExample();
      }
    });

    var colorinput = document.querySelector('#color');
    colorinput.addEventListener('keyup', updateExample);
    colorinput.addEventListener('change', updateExample);
  }

  </script>
</head>

<body onload='init()'>

<div id=content>
    <h1 id=logo>
      <a href='http://translate.google.com/'>
        <img src='http://www.google.com/images/logos/translate_logo.gif'
             title='Google Translate' alt='Google Translate'></a><br>
      for Google+
    </h1>
<p>
  <b id=language>Language:</b>
  <select id='gt-lang' onchange='changeLang()'>
    <option value='af'>Afrikaans</option>
    <option value='sq'>Albanian</option>
    <option value='ar'>Arabic</option>
    <option value='hy'>Armenian</option>
    <option value='az'>Azerbaijani</option>
    <option value='eu'>Basque</option>
    <option value='be'>Belarusian</option>
    <option value='bn'>Bengali</option>
    <option value='bg'>Bulgarian</option>
    <option value='ca'>Catalan</option>
    <option value='zh-CN'>Chinese (Simplified)</option>
    <option value='zh-TW'>Chinese (Traditional)</option>
    <option value='hr'>Croatian</option>
    <option value='cs'>Czech</option>
    <option value='da'>Danish</option>
    <option value='nl'>Dutch</option>
    <option value='en'>English</option>
    <option value='et'>Estonian</option>
    <option value='tl'>Filipino</option>
    <option value='fi'>Finnish</option>
    <option value='fr'>French</option>
    <option value='gl'>Galician</option>
    <option value='ka'>Georgian</option>
    <option value='de'>German</option>
    <option value='el'>Greek</option>
    <option value='gu'>Gujarati</option>
    <option value='ht'>Haitian Creole</option>
    <option value='iw'>Hebrew</option>
    <option value='hi'>Hindi</option>
    <option value='hu'>Hungarian</option>
    <option value='is'>Icelandic</option>
    <option value='id'>Indonesian</option>
    <option value='ga'>Irish</option>
    <option value='it'>Italian</option>
    <option value='ja'>Japanese</option>
    <option value='kn'>Kannada</option>
    <option value='ko'>Korean</option>
    <option value='la'>Latin</option>
    <option value='lv'>Latvian</option>
    <option value='lt'>Lithuanian</option>
    <option value='mk'>Macedonian</option>
    <option value='ms'>Malay</option>
    <option value='mt'>Maltese</option>
    <option value='no'>Norwegian</option>
    <option value='fa'>Persian</option>
    <option value='pl'>Polish</option>
    <option value='pt'>Portuguese</option>
    <option value='ro'>Romanian</option>
    <option value='ru'>Russian</option>
    <option value='sr'>Serbian</option>
    <option value='sk'>Slovak</option>
    <option value='sl'>Slovenian</option>
    <option value='es'>Spanish</option>
    <option value='sw'>Swahili</option>
    <option value='sv'>Swedish</option>
    <option value='ta'>Tamil</option>
    <option value='te'>Telugu</option>
    <option value='th'>Thai</option>
    <option value='tr'>Turkish</option>
    <option value='uk'>Ukrainian</option>
    <option value='ur'>Urdu</option>
    <option value='vi'>Vietnamese</option>
    <option value='cy'>Welsh</option>
    <option value='yi'>Yiddish</option>
  </select><br>
  <span class=note id=languageDesc>Content will be translated into this
    language.</span>
</p>
<p>
  <input type=checkbox id=autoAdd onchange='changeAuto()'>
    <label for=autoAdd id=autoAddLabel>Always add to Google+</label><br>
  <span class=note id=autoAddDesc>When checked, will always add the translate
    feature to Google+, otherwise it will only be added when you click the
    extension button.</span>
</p>
<p>
  <table>
    <tr><th id=background>Background for the translation:</th>
        <td><input id=color style=width:70px value=#ffff99 dir=ltr>
            <span id=example>Example</span>
        </td>
    </tr>
    <tr>
      <td></td>
      <td id=colorselector>
        <div style='background-color:#ffffff'></div>
        <div style='background-color:#ffcccc'></div>
        <div style='background-color:#ffffcc'></div>
        <div style='background-color:#99ff99'></div>
        <div style='background-color:#ccffff'></div>
        <div style='background-color:#ffccff'></div>
        <div style='background-color:#cccccc;clear:both'></div>
        <div style='background-color:#ffcc99'></div>
        <div style='background-color:#ffff99'></div>
        <div style='background-color:#33ff33'></div>
        <div style='background-color:#99ffff'></div>
        <div style='background-color:#ccccff'></div>
      </td>
    </tr>
  </table>
</p>
<!--button onclick='save_options()'>Save</button-->
<span id=status style=color:red;visibility:hidden>&nbsp;</span>
</div>
</body>
</html>
